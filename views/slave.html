<!DOCTYPE html>
<html>

<head>
  <!-- application css-->
  <link rel="stylesheet" href="/stylesheets/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, height=device-height">
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="libs/jquery.ajax-cross-origin.min.js"></script>
  <script src="main.js" type="text/javascript"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
</head>

<body class="unselectable wrapper">
  <form id="socketID" style="position: fixed; text-align: center; margin-left: auto; margin-right: auto; left: 0; right: 0; margin-top: -5px;"></form>
  <div id="content"></div>
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
  var presentation = []
  var robot = null
  var socket = io.connect('http://localhost:3000');
  socket.on('connect', function() {
    console.log(socket.id)
    console.log(document.getElementsByClassName("punch-viewer-full-screen"))
    $('#socketID')[0].innerHTML = socket.id
    $('#socketID')[0].style.display = 'block'

    socket.emit('recieveUserNameSlave', {
      //normally this would be dynamically added based on user input, but for examples sake
      name: 'slave-'
    });

    socket.on('message', function(m) {
      console.log(m)

      if (robot === null) {
        robot = new Robot()
        sessionP = robot.startSession(m.message, function() {
          $('#socketID')[0].style.display = 'none'
          socket.emit('sendToMaster', {
            socket: m.masterSocket,
            mySocket: socket.id,
            message: 'Connection Established',
            requestPresentation: true
          }), function() {
            $('#socketID')[0].style.display = 'block'
            socket.emit('sendToMaster', {
              socket: m.masterSocket,
              mySocket: socket.id,
              message: 'Connection Lost'
            })
          }
        })
      }
    });

    socket.on('presentation', function(m) {
      console.log(m)
      let data = { pres: m.message }
      $.ajax({
        crossOrigin: true,
        type: 'POST',
        url: window.location.href + '/getPresentation',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(d) {
          console.log(d)
          d = JSON.parse(d)
          d.img.forEach((img) => {
            console.log(img)
            $("body").append( "<img style='display: none' id='" + img.split('.')[0] + "' src='/slave/get/"+ d.dir + '/' + img +"'>" );
          })
          sessionP.service("ALMemory").then(function(ALMemory) {
            ALMemory.subscriber("ALTextToSpeech/CurrentSentence").then(function(sub) {
              sub.signal.connect(function(value) {
                console.log(value)
                console.log(d.img)
                for(i = 0; i < d.img.length; i++) {
                  console.log(d.img[i].split('.')[0])
                  if(value.includes(d.img[i].split('.')[0])) {
                    x = document.getElementsByTagName('img')
                    for(j = 0; j < x.length; j++) {
                      x[j].style.display = 'none'
                    }
                    document.getElementById(d.img[i].split('.')[0]).style.display = 'block';
                  }
                }
              });
            });
          });
        }
      })
    })
  })

  socket.on('disconnect', function() {
    window.location.reload();
  })

  </script>
  <!-- qimessaging & jquery stuff-->
  <script src="/libs/qimessaging/1.0/qimessaging.js"></script>
  <script src="/libs/qimessaging/1.0/socket.io.min.js"></script>
  <script src="/scripts/Session.js"></script>
  <script src="/scripts/Robot.js"></script>
  <script src="/scripts/Playlist.js"></script>
  <script src="/scripts/Assigned.js"></script>
</body>

</html>
